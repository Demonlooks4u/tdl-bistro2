<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TDL Bistro</title>
    <meta name="theme-color" content="#0f766e">
    <meta name="description" content="To-Do List для руководителя ресторана">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMwRjc2NkUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTMgNkg1SDIxTTcgNlYyMEM3IDIxLjEwNDYgNy44OTU0MyAyMiA5IDIySDE1QzE2LjEwNDYgMjIgMTcgMjEuMTA0NiAxNyAyMFY2TTEwIDExVjE3TTE0IDExVjE3TTE5IDZIOS41TTkgNkgxNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #0f766e;
            --accent-color: #14b8a6;
            --light-color: #ffffff;
            --dark-color: #333333;
            --gray-color: #64748b;
            --success-color: #10b981;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--primary-color);
            color: var(--light-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: var(--secondary-color);
            color: var(--light-color);
            padding: 15px 0;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 15px;
            position: relative;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .install-btn {
            background-color: var(--accent-color);
            color: var(--light-color);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        .search-panel {
            display: flex;
            margin-bottom: 15px;
            background: var(--dark-color);
            padding: 10px;
            border-radius: 12px;
        }
        
        #task-search {
            flex-grow: 1;
            padding: 12px;
            background: var(--primary-color);
            border: 1px solid var(--secondary-color);
            border-radius: 8px 0 0 8px;
            color: var(--light-color);
            font-size: 16px; /* Предотвращает масштабирование в iOS */
            min-height: 44px;
        }
        
        #clear-search {
            background: var(--secondary-color);
            border: none;
            padding: 0 18px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            color: var(--light-color);
            min-width: 50px;
            min-height: 44px;
        }
        
        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background-color: var(--secondary-color);
            padding: 12px;
            border-radius: 12px;
            color: var(--light-color);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .week-navigation button {
            background-color: var(--accent-color);
            color: var(--light-color);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
            min-height: 44px;
            flex: 1;
            min-width: 120px;
        }
        
        .week-navigation button:hover {
            background-color: #0d9488;
        }
        
        .week-navigation h2 {
            font-size: 1.1rem;
            text-align: center;
            flex: 2;
            min-width: 180px;
        }
        
        .days-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .day-card {
            background-color: var(--dark-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .day-header {
            background-color: var(--secondary-color);
            color: var(--light-color);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .task-list {
            padding: 15px;
            min-height: 200px;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-color);
            min-height: 60px;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-checkbox {
            margin-right: 12px;
            accent-color: var(--accent-color);
            transform: scale(1.3);
            min-width: 24px;
            min-height: 24px;
        }
        
        .task-text {
            flex-grow: 1;
            color: var(--light-color);
            font-size: 1rem;
            line-height: 1.4;
            padding-right: 10px;
        }
        
        .task-text.completed {
            text-decoration: line-through;
            color: var(--gray-color);
        }
        
        .task-category {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .task-priority {
            display: inline-block;
            width: 6px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .add-task {
            display: flex;
            margin-top: 15px;
            flex-direction: column;
            gap: 10px;
        }
        
        .add-task input {
            flex-grow: 1;
            padding: 14px;
            border: 1px solid var(--gray-color);
            border-radius: 8px;
            background-color: var(--primary-color);
            color: var(--light-color);
            font-size: 16px;
            min-height: 50px;
        }
        
        .add-task button {
            background-color: var(--accent-color);
            color: var(--light-color);
            border: none;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            min-height: 50px;
        }
        
        .task-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-direction: column;
        }
        
        .category-select, .priority-select {
            flex: 1;
            padding: 12px;
            background: var(--primary-color);
            color: var(--light-color);
            border: 1px solid var(--gray-color);
            border-radius: 8px;
            font-size: 16px;
            min-height: 50px;
        }
        
        .template-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-direction: column;
        }
        
        .template-buttons button {
            flex: 1;
            padding: 12px;
            background: var(--secondary-color);
            color: var(--light-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            margin-left: 10px;
            min-width: 44px;
            min-height: 44px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stats {
            margin-top: 20px;
            background-color: var(--dark-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 15px;
            left: 15px;
            padding: 15px;
            border-radius: 12px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.4rem;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .context-menu {
            position: fixed;
            background: var(--dark-color);
            border: 1px solid var(--secondary-color);
            border-radius: 12px;
            padding: 10px 0;
            z-index: 1000;
            width: 90%;
            left: 5%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .menu-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--secondary-color);
            font-size: 1rem;
        }
        
        .menu-item {
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        
        .menu-item:hover {
            background: var(--secondary-color);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--dark-color);
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .day-option {
            padding: 15px;
            border: 1px solid var(--gray-color);
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        
        .day-option:hover {
            background: var(--secondary-color);
        }
        
        .data-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-direction: column;
        }
        
        .data-actions button {
            padding: 14px;
            background: var(--accent-color);
            color: var(--light-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            min-height: 50px;
        }
        
        #online-status {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #10b981;
            z-index: 1000;
            border: 2px solid var(--dark-color);
        }
        
        body.offline::before {
            content: "Офлайн";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: black;
            text-align: center;
            padding: 8px;
            z-index: 1001;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        mark {
            background-color: #fef3c7;
            color: #000;
        }
        
        /* Стили для мобильных устройств с шириной экрана больше 768px */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 20px;
            }
            
            .days-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
            
            .week-navigation {
                flex-wrap: nowrap;
            }
            
            .week-navigation button {
                flex: 1;
            }
            
            .task-controls {
                flex-direction: row;
            }
            
            .template-buttons {
                flex-direction: row;
            }
            
            .add-task {
                flex-direction: row;
            }
            
            .data-actions {
                flex-direction: row;
            }
            
            .notification {
                right: 20px;
                left: auto;
                width: auto;
                min-width: 300px;
            }
            
            .context-menu {
                width: auto;
                left: auto;
                min-width: 250px;
            }
        }
        
        /* Стили для очень маленьких экранов */
        @media (max-width: 360px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .week-navigation h2 {
                font-size: 1rem;
            }
            
            .task-text {
                font-size: 0.9rem;
            }
        }
        
        /* Улучшение для iOS */
        @supports (-webkit-touch-callout: none) {
            .task-checkbox {
                transform: scale(1.2);
            }
            
            input, select, textarea, button {
                font-size: 16px; /* Предотвращает масштабирование в iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TDL Bistro</h1>
            <p>Планируйте задачи на неделю и отслеживайте выполнение</p>
            <button class="install-btn" id="installButton">Установить приложение</button>
        </header>
        
        <div class="search-panel">
            <input type="text" id="task-search" placeholder="Поиск задач по текущей неделе...">
            <button id="clear-search">✕</button>
        </div>
        
        <div class="week-navigation">
            <button id="prev-week">← Предыдущая неделя</button>
            <h2 id="current-week">Неделя 23-29 мая</h2>
            <button id="next-week">Следующая неделя →</button>
        </div>
        
        <div class="days-container" id="days-container">
            <!-- Дни недели будут сгенерированы через JavaScript -->
        </div>
        
        <div class="data-actions">
            <button id="export-data">Экспорт данных</button>
            <button id="import-data">Импорт данных</button>
        </div>
        
        <div class="stats">
            <h3>Статистика выполнения задач</h3>
            <p>Всего задач: <span id="total-tasks">0</span></p>
            <p>Выполнено: <span id="completed-tasks">0</span></p>
            <p>Процент выполнения: <span id="completion-rate">0%</span></p>
            <!-- Визуализация будет добавлена через JavaScript -->
        </div>
    </div>

    <script>
        // Данные приложения
        let currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1); // Начало недели (понедельник)
        
        const daysOfWeek = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
        
        // Категории задач
        const taskCategories = {
            'personnel': { name: 'Персонал', color: '#3b82f6' },
            'supplies': { name: 'Поставки', color: '#8b5cf6' },
            'menu': { name: 'Меню', color: '#ec4899' },
            'cleaning': { name: 'Уборка', color: '#10b981' },
            'equipment': { name: 'Оборудование', color: '#f59e0b' },
            'finance': { name: 'Финансы', color: '#ef4444' },
            'other': { name: 'Другое', color: '#64748b' }
        };
        
        // Приоритеты задач
        const taskPriorities = {
            'high': { name: 'Высокий', color: '#ef4444' },
            'medium': { name: 'Средний', color: '#f59e0b' },
            'low': { name: 'Низкий', color: '#10b981' }
        };
        
        // Шаблоны задач
        const dayTemplates = {
            'opening': [
                'Проверить поставки',
                'Собрать утренний брифинг',
                'Проверить чистоту зала'
            ],
            'closing': [
                'Подвести дневную выручку',
                'Составить заказ на завтра',
                'Проверить закрытие смен'
            ]
        };

        // Вспомогательные функции
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function validateTaskText(text) {
            if (!text || text.trim().length === 0) {
                throw new Error('Текст задачи не может быть пустым');
            }
            if (text.length > 500) {
                throw new Error('Текст задачи не может превышать 500 символов');
            }
            return text.trim();
        }

        function sanitizeInput(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.textContent;
        }

        function showNotification(message, type = 'info') {
            // Удаляем существующие уведомления
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                if (notification.parentNode) {
                    notification.remove();
                }
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close">×</button>
            `;
            
            document.body.appendChild(notification);
            
            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
            
            // Закрытие по клику
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            // Закрытие по тапу на мобильных устройствах
            notification.addEventListener('touchend', (e) => {
                if (e.target === notification || e.target.classList.contains('notification-close')) {
                    notification.remove();
                }
            });
        }

        function confirmAction(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }

        // Загрузка и сохранение данных
        function loadTasks() {
            try {
                const saved = localStorage.getItem('tdlBistroTasks');
                if (saved) {
                    const tasks = JSON.parse(saved);
                    // Конвертация старых данных в новый формат
                    return convertLegacyData(tasks);
                }
                return {};
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                showNotification('Ошибка загрузки данных', 'error');
                return {};
            }
        }

        function convertLegacyData(tasks) {
            const converted = {};
            
            Object.keys(tasks).forEach(dayKey => {
                converted[dayKey] = tasks[dayKey].map(task => {
                    if (typeof task === 'string') {
                        // Старый формат: строка
                        return {
                            id: generateId(),
                            text: task,
                            completed: false,
                            category: 'other',
                            priority: 'medium',
                            createdAt: Date.now()
                        };
                    } else if (!task.id) {
                        // Старый формат: объект без id
                        return {
                            id: generateId(),
                            text: task.text,
                            completed: task.completed || false,
                            category: task.category || 'other',
                            priority: task.priority || 'medium',
                            createdAt: task.createdAt || Date.now()
                        };
                    }
                    return task;
                });
            });
            
            return converted;
        }

        function safeSaveTasks(tasks) {
            try {
                localStorage.setItem('tdlBistroTasks', JSON.stringify(tasks));
                return true;
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                showNotification('Ошибка сохранения данных. Проверьте доступное место.', 'error');
                return false;
            }
        }

        function saveTasks(tasks) {
            safeSaveTasks(tasks);
        }

        // Функции работы с датами
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `${day < 10 ? '0' + day : day}.${month < 10 ? '0' + month : month}`;
        }

        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            document.getElementById('current-week').textContent = 
                `Неделя ${formatDate(currentWeekStart)} - ${formatDate(weekEnd)}`;
        }

        // Функции работы с задачами
        function addTask(dayKey, text, category = 'other', priority = 'medium') {
            try {
                validateTaskText(text);
                const tasks = loadTasks();
                
                if (!tasks[dayKey]) {
                    tasks[dayKey] = [];
                }
                
                // Добавляем новую задачу, не перезаписывая существующие
                tasks[dayKey].push({
                    id: generateId(),
                    text: sanitizeInput(text),
                    completed: false,
                    category: category,
                    priority: priority,
                    createdAt: Date.now()
                });
                
                saveTasks(tasks);
                showNotification('Задача добавлена', 'success');
                return true;
            } catch (error) {
                showNotification(error.message, 'error');
                return false;
            }
        }

        function toggleTask(dayKey, taskId) {
            const tasks = loadTasks();
            
            if (tasks[dayKey]) {
                const taskIndex = tasks[dayKey].findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    // Изменяем только статус выполнения
                    tasks[dayKey][taskIndex].completed = !tasks[dayKey][taskIndex].completed;
                    saveTasks(tasks);
                    return true;
                }
            }
            return false;
        }

        function deleteTask(dayKey, taskId) {
            const tasks = loadTasks();
            
            if (tasks[dayKey]) {
                const taskIndex = tasks[dayKey].findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    tasks[dayKey].splice(taskIndex, 1);
                    if (tasks[dayKey].length === 0) {
                        delete tasks[dayKey];
                    }
                    saveTasks(tasks);
                    showNotification('Задача удалена', 'success');
                    return true;
                }
            }
            return false;
        }

        function moveTask(sourceDayKey, taskId, targetDayKey) {
            const tasks = loadTasks();
            
            if (tasks[sourceDayKey]) {
                const taskIndex = tasks[sourceDayKey].findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    const task = tasks[sourceDayKey][taskIndex];
                    
                    // Удаляем из исходного дня
                    tasks[sourceDayKey].splice(taskIndex, 1);
                    
                    // Добавляем в целевой день
                    if (!tasks[targetDayKey]) {
                        tasks[targetDayKey] = [];
                    }
                    tasks[targetDayKey].push(task);
                    
                    // Сохраняем изменения
                    saveTasks(tasks);
                    showNotification('Задача перемещена', 'success');
                    return true;
                }
            }
            return false;
        }

        function duplicateTask(dayKey, taskId) {
            const tasks = loadTasks();
            
            if (tasks[dayKey]) {
                const taskIndex = tasks[dayKey].findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    const originalTask = tasks[dayKey][taskIndex];
                    const duplicatedTask = {
                        ...originalTask,
                        id: generateId(),
                        createdAt: Date.now()
                    };
                    
                    tasks[dayKey].splice(taskIndex + 1, 0, duplicatedTask);
                    saveTasks(tasks);
                    showNotification('Задача дублирована', 'success');
                    return true;
                }
            }
            return false;
        }

        // Функции отображения
        function createDayCard(dayIndex) {
            const dayDate = new Date(currentWeekStart);
            dayDate.setDate(dayDate.getDate() + dayIndex);
            
            const dayKey = dayDate.toISOString().split('T')[0];
            const tasks = loadTasks();
            const dayTasks = tasks[dayKey] || [];
            
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.textContent = `${daysOfWeek[dayIndex]} (${formatDate(dayDate)})`;
            dayHeader.dataset.dayKey = dayKey;
            
            const taskList = document.createElement('div');
            taskList.className = 'task-list';
            
            // Отображение задач дня
            dayTasks.forEach((task) => {
                const taskItem = createTaskItem(task, dayKey);
                taskList.appendChild(taskItem);
            });
            
            // Панель управления задачами
            const taskControls = document.createElement('div');
            taskControls.className = 'task-controls';
            
            const categorySelect = document.createElement('select');
            categorySelect.className = 'category-select';
            
            Object.entries(taskCategories).forEach(([key, category]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            const prioritySelect = document.createElement('select');
            prioritySelect.className = 'priority-select';
            
            Object.entries(taskPriorities).forEach(([key, priority]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = priority.name;
                prioritySelect.appendChild(option);
            });
            
            taskControls.appendChild(categorySelect);
            taskControls.appendChild(prioritySelect);
            
            // Форма добавления новой задачи
            const addTaskForm = document.createElement('div');
            addTaskForm.className = 'add-task';
            
            const taskInput = document.createElement('input');
            taskInput.type = 'text';
            taskInput.placeholder = 'Добавить задачу...';
            
            const addButton = document.createElement('button');
            addButton.textContent = 'Добавить';
            
            addButton.addEventListener('click', () => {
                const taskText = taskInput.value.trim();
                const category = categorySelect.value;
                const priority = prioritySelect.value;
                
                if (taskText && addTask(dayKey, taskText, category, priority)) {
                    taskInput.value = '';
                    renderDays();
                    updateStats();
                }
            });
            
            // Обработчик для мобильных устройств (touch)
            addButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                const taskText = taskInput.value.trim();
                const category = categorySelect.value;
                const priority = prioritySelect.value;
                
                if (taskText && addTask(dayKey, taskText, category, priority)) {
                    taskInput.value = '';
                    renderDays();
                    updateStats();
                }
            });
            
            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addButton.click();
                }
            });
            
            addTaskForm.appendChild(taskInput);
            addTaskForm.appendChild(addButton);
            
            // Кнопки шаблонов
            const templateButtons = document.createElement('div');
            templateButtons.className = 'template-buttons';
            
            const openingButton = document.createElement('button');
            openingButton.textContent = 'Утренние задачи';
            openingButton.addEventListener('click', () => {
                applyTemplate(dayKey, 'opening');
            });
            
            openingButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                applyTemplate(dayKey, 'opening');
            });
            
            const closingButton = document.createElement('button');
            closingButton.textContent = 'Вечерние задачи';
            closingButton.addEventListener('click', () => {
                applyTemplate(dayKey, 'closing');
            });
            
            closingButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                applyTemplate(dayKey, 'closing');
            });
            
            templateButtons.appendChild(openingButton);
            templateButtons.appendChild(closingButton);
            
            dayCard.appendChild(dayHeader);
            dayCard.appendChild(taskList);
            dayCard.appendChild(taskControls);
            dayCard.appendChild(addTaskForm);
            dayCard.appendChild(templateButtons);
            
            return dayCard;
        }

        function createTaskItem(task, dayKey) {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.dataset.taskId = task.id;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = task.completed;
            
            checkbox.addEventListener('change', () => {
                if (toggleTask(dayKey, task.id)) {
                    renderDays();
                    updateStats();
                }
            });
            
            // Обработчик для мобильных устройств
            checkbox.addEventListener('touchend', (e) => {
                e.preventDefault();
                checkbox.checked = !checkbox.checked;
                if (toggleTask(dayKey, task.id)) {
                    renderDays();
                    updateStats();
                }
            });
            
            const categoryIndicator = document.createElement('span');
            categoryIndicator.className = 'task-category';
            categoryIndicator.style.backgroundColor = taskCategories[task.category].color;
            
            const priorityIndicator = document.createElement('span');
            priorityIndicator.className = 'task-priority';
            priorityIndicator.style.backgroundColor = taskPriorities[task.priority].color;
            
            const taskText = document.createElement('span');
            taskText.className = 'task-text';
            taskText.textContent = task.text;
            if (task.completed) {
                taskText.classList.add('completed');
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '✕';
            
            deleteBtn.addEventListener('click', () => {
                confirmAction(`Удалить задачу "${task.text}"?`, () => {
                    if (deleteTask(dayKey, task.id)) {
                        renderDays();
                        updateStats();
                    }
                });
            });
            
            // Обработчик для мобильных устройств
            deleteBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                confirmAction(`Удалить задачу "${task.text}"?`, () => {
                    if (deleteTask(dayKey, task.id)) {
                        renderDays();
                        updateStats();
                    }
                });
            });
            
            taskItem.appendChild(checkbox);
            taskItem.appendChild(categoryIndicator);
            taskItem.appendChild(priorityIndicator);
            taskItem.appendChild(taskText);
            taskItem.appendChild(deleteBtn);
            
            // Добавляем контекстное меню по долгому нажатию (для мобильных)
            let touchTimer;
            taskItem.addEventListener('touchstart', (e) => {
                touchTimer = setTimeout(() => {
                    e.preventDefault();
                    showTaskContextMenu(e.touches[0].clientX, e.touches[0].clientY, taskItem, dayKey, task.id, task.text);
                }, 500); // 500ms для долгого нажатия
            });
            
            taskItem.addEventListener('touchend', () => {
                clearTimeout(touchTimer);
            });
            
            // Контекстное меню для десктопа (правый клик)
            taskItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showTaskContextMenu(e.pageX, e.pageY, taskItem, dayKey, task.id, task.text);
            });
            
            return taskItem;
        }

        function applyTemplate(dayKey, templateName) {
            const tasks = dayTemplates[templateName];
            let addedCount = 0;
            
            tasks.forEach(taskText => {
                if (addTask(dayKey, taskText, 'other', 'medium')) {
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                showNotification(`Добавлено ${addedCount} задач из шаблона`, 'success');
                renderDays();
                updateStats();
            }
        }

        // Контекстное меню для задач
        function showTaskContextMenu(x, y, taskItem, dayKey, taskId, taskText) {
            // Удаляем существующее меню
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            
            // Позиционирование для мобильных устройств
            if (window.innerWidth <= 768) {
                menu.style.top = '50%';
                menu.style.left = '5%';
                menu.style.transform = 'translateY(-50%)';
            } else {
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
            }
            
            menu.innerHTML = `
                <div class="menu-header">
                    <strong>${taskText.substring(0, 30)}${taskText.length > 30 ? '...' : ''}</strong>
                </div>
                <div class="menu-item" data-action="move">Переместить задачу</div>
                <div class="menu-item" data-action="duplicate">Дублировать</div>
                <div class="menu-item" data-action="delete" style="color: #ef4444;">Удалить</div>
            `;
            
            document.body.appendChild(menu);
            
            // Обработчики для пунктов меню
            menu.querySelector('[data-action="move"]').addEventListener('click', () => {
                showDaySelectionModal(dayKey, taskId, taskText);
                menu.remove();
            });
            
            menu.querySelector('[data-action="duplicate"]').addEventListener('click', () => {
                if (duplicateTask(dayKey, taskId)) {
                    renderDays();
                    updateStats();
                }
                menu.remove();
            });
            
            menu.querySelector('[data-action="delete"]').addEventListener('click', () => {
                confirmAction(`Удалить задачу "${taskText}"?`, () => {
                    if (deleteTask(dayKey, taskId)) {
                        renderDays();
                        updateStats();
                    }
                });
                menu.remove();
            });
            
            // Обработчики для touch-устройств
            menu.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    item.click();
                });
            });
            
            // Закрытие меню при клике/тапе вне его
            setTimeout(() => {
                const closeMenu = () => {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                    document.removeEventListener('touchend', closeMenu);
                };
                document.addEventListener('click', closeMenu);
                document.addEventListener('touchend', closeMenu);
            }, 100);
        }

        function showDaySelectionModal(sourceDayKey, taskId, taskText) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            let daysHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + i);
                const dayKey = dayDate.toISOString().split('T')[0];
                
                if (dayKey !== sourceDayKey) {
                    daysHTML += `
                        <div class="day-option" data-day="${dayKey}">
                            ${daysOfWeek[i]} (${formatDate(dayDate)})
                        </div>
                    `;
                }
            }
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px;">Переместить задачу</h3>
                    <p style="margin-bottom: 15px; color: var(--gray-color);">"${taskText}"</p>
                    <div class="days-list" style="max-height: 300px; overflow-y: auto;">
                        ${daysHTML}
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button id="cancel-move" style="background: var(--gray-color); margin-right: 10px; padding: 12px 18px; border: none; border-radius: 8px; color: white; cursor: pointer; min-height: 44px;">Отмена</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Обработчики для выбора дня
            modal.querySelectorAll('.day-option').forEach(option => {
                option.addEventListener('click', () => {
                    const targetDayKey = option.dataset.day;
                    if (moveTask(sourceDayKey, taskId, targetDayKey)) {
                        renderDays();
                        updateStats();
                    }
                    modal.remove();
                });
                
                // Обработчики для touch-устройств
                option.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    option.click();
                });
            });
            
            const cancelButton = modal.querySelector('#cancel-move');
            cancelButton.addEventListener('click', () => {
                modal.remove();
            });
            
            cancelButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                modal.remove();
            });
        }

        // Поиск и фильтрация
        function addSearchFunctionality() {
            const searchInput = document.getElementById('task-search');
            const clearButton = document.getElementById('clear-search');
            
            searchInput.addEventListener('input', debounce((e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                filterTasks(searchTerm);
            }, 300));
            
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                filterTasks('');
            });
            
            // Обработчики для touch-устройств
            clearButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                searchInput.value = '';
                filterTasks('');
            });
        }

        function filterTasks(searchTerm) {
            const taskElements = document.querySelectorAll('.task-text');
            let visibleCount = 0;
            
            taskElements.forEach(taskElement => {
                const taskItem = taskElement.closest('.task-item');
                const taskText = taskElement.textContent.toLowerCase();
                
                if (searchTerm === '' || taskText.includes(searchTerm)) {
                    taskItem.style.display = 'flex';
                    visibleCount++;
                    
                    // Подсветка совпадения
                    if (searchTerm) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        taskElement.innerHTML = taskElement.textContent.replace(regex, '<mark>$1</mark>');
                    } else {
                        taskElement.innerHTML = taskElement.textContent;
                    }
                } else {
                    taskItem.style.display = 'none';
                }
            });
            
            // Показываем статистику поиска
            const totalTasks = document.querySelectorAll('.task-item').length;
            
            if (searchTerm && visibleCount > 0) {
                showNotification(`Найдено задач: ${visibleCount} из ${totalTasks}`, 'info');
            } else if (searchTerm && visibleCount === 0) {
                showNotification('Задачи не найдены', 'info');
            }
        }

        // Статистика и визуализация
        function updateStats() {
            const tasks = loadTasks();
            let totalTasks = 0;
            let completedTasks = 0;
            let tasksByCategory = {};
            let tasksByPriority = {};
            
            Object.values(tasks).forEach(dayTasks => {
                dayTasks.forEach(task => {
                    totalTasks++;
                    if (task.completed) completedTasks++;
                    
                    // Статистика по категориям
                    if (!tasksByCategory[task.category]) {
                        tasksByCategory[task.category] = { total: 0, completed: 0 };
                    }
                    tasksByCategory[task.category].total++;
                    if (task.completed) {
                        tasksByCategory[task.category].completed++;
                    }
                    
                    // Статистика по приоритетам
                    if (!tasksByPriority[task.priority]) {
                        tasksByPriority[task.priority] = { total: 0, completed: 0 };
                    }
                    tasksByPriority[task.priority].total++;
                    if (task.completed) {
                        tasksByPriority[task.priority].completed++;
                    }
                });
            });
            
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            
            // Визуализация прогресса
            updateProgressVisualization(completionRate, tasksByCategory, tasksByPriority);
        }

        function updateProgressVisualization(completionRate, tasksByCategory, tasksByPriority) {
            const statsElement = document.querySelector('.stats');
            
            // Удаляем старую визуализацию
            const oldCharts = statsElement.querySelectorAll('.progress-chart, .category-stats, .priority-stats');
            oldCharts.forEach(chart => chart.remove());
            
            // Добавляем круговую диаграмму выполнения
            const progressHTML = `
                <div class="progress-chart" style="margin: 20px 0;">
                    <h4>Общий прогресс выполнения</h4>
                    <div class="progress-circle" style="
                        width: 120px; 
                        height: 120px; 
                        border-radius: 50%; 
                        background: conic-gradient(var(--accent-color) ${completionRate * 3.6}deg, var(--gray-color) 0deg);
                        margin: 15px auto;
                        position: relative;
                    ">
                        <div style="
                            position: absolute;
                            top: 10px;
                            left: 10px;
                            right: 10px;
                            bottom: 10px;
                            background: var(--dark-color);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 1.2rem;
                        ">${completionRate}%</div>
                    </div>
                </div>
            `;
            
            statsElement.insertAdjacentHTML('beforeend', progressHTML);
            
            // Добавляем статистику по категориям
            let categoryStatsHTML = '<div class="category-stats" style="margin: 20px 0;"><h4>Выполнение по категориям</h4>';
            
            Object.entries(tasksByCategory).forEach(([categoryKey, stats]) => {
                const category = taskCategories[categoryKey];
                const rate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                
                categoryStatsHTML += `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: ${category.color}">${category.name}</span>
                            <span>${rate}%</span>
                        </div>
                        <div style="height: 8px; background: var(--gray-color); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: ${category.color}; width: ${rate}%;"></div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--gray-color); text-align: right;">
                            ${stats.completed}/${stats.total}
                        </div>
                    </div>
                `;
            });
            
            categoryStatsHTML += '</div>';
            statsElement.insertAdjacentHTML('beforeend', categoryStatsHTML);
        }

        // Экспорт и импорт данных
        function exportToClipboard() {
            const tasks = loadTasks();
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                tasks: tasks
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            
            navigator.clipboard.writeText(dataStr).then(() => {
                showNotification('Данные скопированы в буфер обмена', 'success');
            }).catch(() => {
                // Fallback для браузеров без clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = dataStr;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Данные скопированы в буфер обмена', 'success');
            });
        }

        function importFromClipboard() {
            const importText = prompt('Вставьте данные для импорта:');
            if (importText) {
                try {
                    const importData = JSON.parse(importText);
                    if (importData.tasks) {
                        if (confirm('Заменить текущие данные импортируемыми?')) {
                            localStorage.setItem('tdlBistroTasks', JSON.stringify(importData.tasks));
                            showNotification('Данные успешно импортированы', 'success');
                            location.reload();
                        }
                    } else {
                        showNotification('Неверный формат данных', 'error');
                    }
                } catch (error) {
                    showNotification('Ошибка при импорте данных', 'error');
                }
            }
        }

        // PWA функциональность
        function addOfflineSupport() {
            // Показываем уведомление при потере соединения
            window.addEventListener('online', () => {
                showNotification('Соединение восстановлено', 'success');
                document.body.classList.remove('offline');
            });
            
            window.addEventListener('offline', () => {
                showNotification('Работаем в офлайн-режиме. Данные сохраняются локально.', 'info');
                document.body.classList.add('offline');
            });
            
            // Добавляем индикатор онлайн-статуса
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'online-status';
            document.body.appendChild(statusIndicator);
            
            // Обновляем индикатор при изменении статуса
            function updateOnlineStatus() {
                const statusElement = document.getElementById('online-status');
                if (navigator.onLine) {
                    statusElement.style.background = '#10b981';
                } else {
                    statusElement.style.background = '#ef4444';
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });
        
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installButton.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });
        
        // Обработчик для touch-устройств
        installButton.addEventListener('touchend', async (e) => {
            e.preventDefault();
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installButton.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });
        
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            deferredPrompt = null;
        });

        // Основные функции приложения
        function renderDays() {
            const daysContainer = document.getElementById('days-container');
            daysContainer.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const dayCard = createDayCard(i);
                daysContainer.appendChild(dayCard);
            }
        }

        function init() {
            updateWeekDisplay();
            renderDays();
            updateStats();
            addSearchFunctionality();
            addOfflineSupport();
            
            // Навигация по неделям
            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateWeekDisplay();
                renderDays();
            });
            
            document.getElementById('next-week').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateWeekDisplay();
                renderDays();
            });
            
            // Обработчики для touch-устройств
            document.getElementById('prev-week').addEventListener('touchend', (e) => {
                e.preventDefault();
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateWeekDisplay();
                renderDays();
            });
            
            document.getElementById('next-week').addEventListener('touchend', (e) => {
                e.preventDefault();
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateWeekDisplay();
                renderDays();
            });
            
            // Экспорт/импорт данных
            document.getElementById('export-data').addEventListener('click', exportToClipboard);
            document.getElementById('import-data').addEventListener('click', importFromClipboard);
            
            // Обработчики для touch-устройств
            document.getElementById('export-data').addEventListener('touchend', (e) => {
                e.preventDefault();
                exportToClipboard();
            });
            
            document.getElementById('import-data').addEventListener('touchend', (e) => {
                e.preventDefault();
                importFromClipboard();
            });
        }

        // Запуск приложения
        init();
    </script>
</body>

</html>
